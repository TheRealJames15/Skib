<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapLite+ with Friends & Chat</title>
    <style>
        :root {
            --snap-yellow: #fffc00;
            --snap-black: #000000;
            --snap-white: #ffffff;
            --snap-gray: #f5f5f5;
            --snap-blue: #007aff;
            --snap-green: #34c759;
            --snap-red: #ff3b30;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--snap-gray);
            color: var(--snap-black);
            line-height: 1.6;
        }
        
        header {
            background-color: var(--snap-yellow);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        nav {
            display: flex;
            gap: 15px;
        }
        
        nav a {
            color: var(--snap-black);
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 15px;
            position: relative;
        }
        
        nav a:hover {
            background-color: rgba(0,0,0,0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--snap-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .card {
            background-color: var(--snap-white);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
        }
        
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        input, textarea, button {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--snap-yellow);
            color: var(--snap-black);
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        button.primary {
            background-color: var(--snap-blue);
            color: white;
        }
        
        button.success {
            background-color: var(--snap-green);
            color: white;
        }
        
        button.danger {
            background-color: var(--snap-red);
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .error {
            color: var(--snap-red);
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .success {
            color: var(--snap-green);
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        /* Friends system styles */
        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .friend-actions {
            display: flex;
            gap: 5px;
        }
        
        /* Chat system styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chat-header {
            background-color: var(--snap-yellow);
            padding: 10px 15px;
            font-weight: bold;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        
        .message.sent {
            margin-left: auto;
            text-align: right;
        }
        
        .message.received {
            margin-right: auto;
        }
        
        .message-content {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 18px;
            background-color: #f0f0f0;
        }
        
        .message.sent .message-content {
            background-color: var(--snap-blue);
            color: white;
        }
        
        .message-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .chat-input {
            display: flex;
            border-top: 1px solid #ddd;
            background-color: white;
        }
        
        .chat-input input {
            flex: 1;
            border: none;
            border-radius: 0;
        }
        
        .chat-input button {
            border-radius: 0;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--snap-blue);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 480px) {
            header {
                padding: 10px 15px;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            nav {
                gap: 10px;
            }
            
            .container {
                padding: 0 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .chat-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">SnapLite+</div>
        <nav>
            <a href="#" id="home-link">Home</a>
            <a href="#" id="login-link" class="hidden">Login</a>
            <a href="#" id="register-link" class="hidden">Register</a>
            <a href="#" id="dashboard-link" class="hidden">My Snaps</a>
            <a href="#" id="friends-link" class="hidden">
                Friends
                <span id="friend-notification-badge" class="notification-badge hidden"></span>
            </a>
            <a href="#" id="chat-link" class="hidden">
                Chat
                <span id="chat-notification-badge" class="notification-badge hidden"></span>
            </a>
            <a href="#" id="logout-link" class="hidden">Logout</a>
        </nav>
    </header>

    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="card">
            <h1>Welcome to SnapLite+</h1>
            <p>A Snapchat-like app with friends and chat - all in your browser!</p>
            <div id="home-buttons" style="margin-top: 20px;">
                <button id="go-to-login" style="margin-right: 10px;">Login</button>
                <button id="go-to-register">Register</button>
            </div>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="card hidden">
            <h2>Login</h2>
            <form id="login-form-element">
                <div>
                    <input type="text" id="login-username" placeholder="Username" required>
                </div>
                <div>
                    <input type="password" id="login-password" placeholder="Password" required>
                </div>
                <div id="login-error" class="error hidden"></div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="card hidden">
            <h2>Register</h2>
            <form id="register-form-element">
                <div>
                    <input type="text" id="register-username" placeholder="Username" required>
                </div>
                <div>
                    <input type="password" id="register-password" placeholder="Password" required>
                </div>
                <div id="register-error" class="error hidden"></div>
                <button type="submit">Register</button>
            </form>
        </div>

        <!-- Dashboard -->
        <!-- Add this to your dashboard section -->
<div class="card" id="send-snap-container">
    <h3>Send a Snap</h3>
    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <img id="captured-image" class="hidden">
    </div>
    <div class="camera-controls">
        <button id="capture-btn">Capture</button>
        <button id="retake-btn" class="hidden">Retake</button>
    </div>
    <form id="send-snap-form">
        <select id="send-to-friend" required>
            <option value="">Select a friend</option>
        </select>
        <input type="text" id="snap-caption" placeholder="Add a caption...">
        <button type="submit" id="send-snap-btn" class="hidden" disabled>Send Snap</button>
    </form>
    <div id="send-snap-error" class="error hidden"></div>
    <div id="send-snap-success" class="success hidden"></div>
</div>
        <div id="dashboard" class="hidden">
            <div class="card">
                <h2 id="welcome-message">Welcome back!</h2>
                <p>You are now logged in. Use the navigation to access friends and chat features.</p>
            </div>
        </div>

        <!-- Friends System -->
        <div id="friends-system" class="hidden">
            <div class="card">
                <h2>Friends</h2>
                
                <div class="tabs">
                    <div class="tab active" data-tab="friends">My Friends</div>
                    <div class="tab" data-tab="requests">Friend Requests</div>
                    <div class="tab" data-tab="search">Add Friends</div>
                </div>
                
                <div class="tab-content active" id="friends-tab">
                    <h3>Your Friends</h3>
                    <div id="friends-list" class="friends-list"></div>
                    <div id="no-friends" class="hidden">You don't have any friends yet.</div>
                </div>
                
                <div class="tab-content" id="requests-tab">
                    <h3>Friend Requests</h3>
                    <div id="received-requests" class="friends-list"></div>
                    <div id="no-requests" class="hidden">You don't have any friend requests.</div>
                </div>
                
                <div class="tab-content" id="search-tab">
                    <h3>Add Friends</h3>
                    <form id="search-friends-form">
                        <input type="text" id="friend-search" placeholder="Search by username">
                        <button type="submit">Search</button>
                    </form>
                    <div id="search-results" class="friends-list" style="margin-top: 15px;"></div>
                    <div id="no-search-results" class="hidden">No users found.</div>
                </div>
            </div>
        </div>

        <!-- Chat System -->
        <div id="chat-system" class="hidden">
            <div class="card">
                <h2>Chat</h2>
                
                <div id="chat-selector" style="margin-bottom: 15px;">
                    <select id="chat-friend-select" style="width: 100%; padding: 10px; border-radius: 8px;">
                        <option value="">Select a friend to chat with</option>
                    </select>
                </div>
                
                <div id="active-chat">
                    <div class="chat-container">
                        <div class="chat-header" id="chat-header">Select a friend to start chatting</div>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-input">
                            <input type="text" id="chat-input" placeholder="Type a message..." disabled>
                            <button id="send-message" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize localStorage if empty
        if (!localStorage.getItem('users')) {
            localStorage.setItem('users', JSON.stringify({}));
        }

        // DOM Elements
        const homeScreen = document.getElementById('home-screen');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const dashboard = document.getElementById('dashboard');
        const friendsSystem = document.getElementById('friends-system');
        const chatSystem = document.getElementById('chat-system');

        // Navigation Links
        const homeLink = document.getElementById('home-link');
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const dashboardLink = document.getElementById('dashboard-link');
        const friendsLink = document.getElementById('friends-link');
        const chatLink = document.getElementById('chat-link');
        const logoutLink = document.getElementById('logout-link');

        // Notification badges
        const friendNotificationBadge = document.getElementById('friend-notification-badge');
        const chatNotificationBadge = document.getElementById('chat-notification-badge');

        // Home buttons
        const goToLogin = document.getElementById('go-to-login');
        const goToRegister = document.getElementById('go-to-register');

        // Forms
        const loginFormElement = document.getElementById('login-form-element');
        const registerFormElement = document.getElementById('register-form-element');
        const searchFriendsForm = document.getElementById('search-friends-form');

        // Chat elements
        const chatFriendSelect = document.getElementById('chat-friend-select');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message');
        const chatHeader = document.getElementById('chat-header');

        // Current state
        let currentUser = null;
        let currentChatFriend = null;
        let chatUpdateInterval = null;

        // Initialize the app
        function init() {
            checkAuthState();
            setupEventListeners();
        }

        // Check if user is logged in
        function checkAuthState() {
            currentUser = localStorage.getItem('currentUser');
            
            if (currentUser) {
                showDashboard();
                updateNotificationBadges();
            } else {
                showHome();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showHome();
            });
            loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                showLogin();
            });
            registerLink.addEventListener('click', (e) => {
                e.preventDefault();
                showRegister();
            });
            dashboardLink.addEventListener('click', (e) => {
                e.preventDefault();
                showDashboard();
            });
            friendsLink.addEventListener('click', (e) => {
                e.preventDefault();
                showFriendsSystem();
            });
            chatLink.addEventListener('click', (e) => {
                e.preventDefault();
                showChatSystem();
            });
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });

            // Home buttons
            goToLogin.addEventListener('click', showLogin);
            goToRegister.addEventListener('click', showRegister);

            // Forms
            loginFormElement.addEventListener('submit', handleLogin);
            registerFormElement.addEventListener('submit', handleRegister);
            searchFriendsForm.addEventListener('submit', searchFriends);

            // Chat system
            chatFriendSelect.addEventListener('change', handleChatFriendSelect);
            sendMessageBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        // Show screens
        function showHome() {
            hideAllScreens();
            homeScreen.classList.remove('hidden');
            updateNav();
        }

        function showLogin() {
            hideAllScreens();
            loginForm.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
            updateNav();
        }

        function showRegister() {
            hideAllScreens();
            registerForm.classList.remove('hidden');
            document.getElementById('register-error').classList.add('hidden');
            updateNav();
        }

        function showDashboard() {
            if (!currentUser) {
                showHome();
                return;
            }

            hideAllScreens();
            dashboard.classList.remove('hidden');
            document.getElementById('welcome-message').textContent = `Welcome, ${currentUser}!`;
            updateNav();
        }

        function showFriendsSystem() {
            if (!currentUser) {
                showHome();
                return;
            }

            hideAllScreens();
            friendsSystem.classList.remove('hidden');
            
            // Load friends data
            loadFriendsList();
            loadFriendRequests();
            
            // Set first tab as active
            document.querySelector('.tab').click();
            
            // Update nav
            updateNav();
        }

        function showChatSystem() {
            if (!currentUser) {
                showHome();
                return;
            }

            hideAllScreens();
            chatSystem.classList.remove('hidden');
            
            // Load friends for chat selection
            loadChatFriends();
            
            // Update nav
            updateNav();
            
            // Start chat update interval
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
            }
            chatUpdateInterval = setInterval(updateChat, 2000);
        }

        function hideAllScreens() {
            homeScreen.classList.add('hidden');
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            dashboard.classList.add('hidden');
            friendsSystem.classList.add('hidden');
            chatSystem.classList.add('hidden');
            
            // Stop chat update interval
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
                chatUpdateInterval = null;
            }
        }

        // Update navigation based on auth state
        function updateNav() {
            if (currentUser) {
                // User is logged in
                loginLink.classList.add('hidden');
                registerLink.classList.add('hidden');
                dashboardLink.classList.remove('hidden');
                friendsLink.classList.remove('hidden');
                chatLink.classList.remove('hidden');
                logoutLink.classList.remove('hidden');
            } else {
                // User is not logged in
                loginLink.classList.remove('hidden');
                registerLink.classList.remove('hidden');
                dashboardLink.classList.add('hidden');
                friendsLink.classList.add('hidden');
                chatLink.classList.add('hidden');
                logoutLink.classList.add('hidden');
            }
        }

        // Auth handlers
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            const users = JSON.parse(localStorage.getItem('users'));
            const errorElement = document.getElementById('login-error');
            
            if (!users[username]) {
                errorElement.textContent = 'Username not found';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (users[username].password !== password) {
                errorElement.textContent = 'Incorrect password';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Successful login
            currentUser = username;
            localStorage.setItem('currentUser', username);
            updateNotificationBadges();
            showDashboard();
        }

        function handleRegister(e) {
            e.preventDefault();
            
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const errorElement = document.getElementById('register-error');
            
            // Validate inputs
            if (username.length < 3) {
                errorElement.textContent = 'Username must be at least 3 characters';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorElement.textContent = 'Password must be at least 6 characters';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            
            // Check if username exists
            if (users[username]) {
                errorElement.textContent = 'Username already exists';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // Create new user
            users[username] = {
                password: password,
                friends: [],
                friendRequests: [],
                sentRequests: [],
                chats: {},
                unreadMessages: {}
            };
            
            // Save to localStorage
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = username;
            localStorage.setItem('currentUser', username);
            
            // Redirect to dashboard
            showDashboard();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showHome();
        }

        // Friends system functions
        function loadFriendsList() {
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[currentUser];
            
            if (!user || !user.friends || user.friends.length === 0) {
                document.getElementById('friends-list').innerHTML = '';
                document.getElementById('no-friends').classList.remove('hidden');
                return;
            }
            
            let friendsHTML = '';
            user.friends.forEach(friendUsername => {
                friendsHTML += `
                    <div class="friend-item">
                        <span>${friendUsername}</span>
                        <div class="friend-actions">
                            <button class="primary" onclick="startChatWithFriend('${friendUsername}')">Chat</button>
                            <button class="danger" onclick="removeFriend('${friendUsername}')">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('friends-list').innerHTML = friendsHTML;
            document.getElementById('no-friends').classList.add('hidden');
        }

        function loadFriendRequests() {
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[currentUser];
            
            if (!user || !user.friendRequests || user.friendRequests.length === 0) {
                document.getElementById('received-requests').innerHTML = '';
                document.getElementById('no-requests').classList.remove('hidden');
                return;
            }
            
            let requestsHTML = '';
            user.friendRequests.forEach(request => {
                requestsHTML += `
                    <div class="friend-item">
                        <span>${request.from}</span>
                        <div class="friend-actions">
                            <button class="success" onclick="acceptFriendRequest('${request.from}')">Accept</button>
                            <button class="danger" onclick="declineFriendRequest('${request.from}')">Decline</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('received-requests').innerHTML = requestsHTML;
            document.getElementById('no-requests').classList.add('hidden');
        }

        function searchFriends(e) {
            e.preventDefault();
            const searchTerm = document.getElementById('friend-search').value.trim().toLowerCase();
            
            if (!searchTerm) {
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('no-search-results').classList.remove('hidden');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[currentUser];
            
            let resultsHTML = '';
            let hasResults = false;
            
            Object.keys(users).forEach(username => {
                // Don't show yourself or existing friends
                if (username !== currentUser && 
                    !user.friends.includes(username) &&
                    !user.sentRequests.some(req => req.to === username) &&
                    username.toLowerCase().includes(searchTerm)) {
                    
                    hasResults = true;
                    const isAlreadyRequested = user.sentRequests.some(req => req.to === username);
                    
                    resultsHTML += `
                        <div class="friend-item">
                            <span>${username}</span>
                            <div class="friend-actions">
                                ${isAlreadyRequested ? 
                                    '<span>Request Sent</span>' : 
                                    `<button class="primary" onclick="sendFriendRequest('${username}')">Add Friend</button>`
                                }
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('search-results').innerHTML = resultsHTML;
            document.getElementById('no-search-results').classList.toggle('hidden', hasResults);
        }

        function sendFriendRequest(toUsername) {
            const users = JSON.parse(localStorage.getItem('users'));
            
            // Add to sender's sent requests
            users[currentUser].sentRequests.push({
                to: toUsername,
                date: new Date().toISOString()
            });
            
            // Add to recipient's friend requests
            users[toUsername].friendRequests.push({
                from: currentUser,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update UI
            searchFriends({ preventDefault: () => {} });
            updateNotificationBadges();
            
            alert(`Friend request sent to ${toUsername}`);
        }

        function acceptFriendRequest(fromUsername) {
            const users = JSON.parse(localStorage.getItem('users'));
            
            // Remove from recipient's friend requests
            users[currentUser].friendRequests = users[currentUser].friendRequests.filter(
                req => req.from !== fromUsername
            );
            
            // Remove from sender's sent requests
            users[fromUsername].sentRequests = users[fromUsername].sentRequests.filter(
                req => req.to !== currentUser
            );
            
            // Add to both friends lists
            if (!users[currentUser].friends.includes(fromUsername)) {
                users[currentUser].friends.push(fromUsername);
            }
            
            if (!users[fromUsername].friends.includes(currentUser)) {
                users[fromUsername].friends.push(currentUser);
            }
            
            // Initialize chat if it doesn't exist
            if (!users[currentUser].chats[fromUsername]) {
                users[currentUser].chats[fromUsername] = [];
            }
            
            if (!users[fromUsername].chats[currentUser]) {
                users[fromUsername].chats[currentUser] = [];
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update UI
            loadFriendRequests();
            loadFriendsList();
            updateNotificationBadges();
            
            alert(`You are now friends with ${fromUsername}`);
        }

        function declineFriendRequest(fromUsername) {
            const users = JSON.parse(localStorage.getItem('users'));
            
            // Remove from recipient's friend requests
            users[currentUser].friendRequests = users[currentUser].friendRequests.filter(
                req => req.from !== fromUsername
            );
            
            // Remove from sender's sent requests
            users[fromUsername].sentRequests = users[fromUsername].sentRequests.filter(
                req => req.to !== currentUser
            );
            
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update UI
            loadFriendRequests();
            updateNotificationBadges();
        }

        function removeFriend(friendUsername) {
            if (!confirm(`Are you sure you want to remove ${friendUsername} as a friend?`)) {
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            
            // Remove from both friends lists
            users[currentUser].friends = users[currentUser].friends.filter(
                friend => friend !== friendUsername
            );
            
            users[friendUsername].friends = users[friendUsername].friends.filter(
                friend => friend !== currentUser
            );
            
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update UI
            loadFriendsList();
            
            // If we're currently chatting with this friend, close the chat
            if (currentChatFriend === friendUsername) {
                currentChatFriend = null;
                chatFriendSelect.value = '';
                chatMessages.innerHTML = '';
                chatHeader.textContent = 'Select a friend to start chatting';
                chatInput.disabled = true;
                sendMessageBtn.disabled = true;
            }
            
            // Reload chat friends list
            if (chatSystem.classList.contains('hidden') === false) {
                loadChatFriends();
            }
        }

        function startChatWithFriend(friendUsername) {
            showChatSystem();
            chatFriendSelect.value = friendUsername;
            handleChatFriendSelect({ target: { value: friendUsername } });
        }

        // Chat system functions
        function loadChatFriends() {
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[currentUser];
            
            chatFriendSelect.innerHTML = '<option value="">Select a friend to chat with</option>';
            
            if (user && user.friends && user.friends.length > 0) {
                user.friends.forEach(friend => {
                    const option = document.createElement('option');
                    option.value = friend;
                    option.textContent = friend;
                    chatFriendSelect.appendChild(option);
                });
            }
        }

        function handleChatFriendSelect(e) {
            currentChatFriend = e.target.value;
            
            if (currentChatFriend) {
                loadChat(currentChatFriend);
                chatInput.disabled = false;
                sendMessageBtn.disabled = false;
                chatHeader.textContent = `Chat with ${currentChatFriend}`;
                
                // Mark messages as read
                const users = JSON.parse(localStorage.getItem('users'));
                if (users[currentUser].unreadMessages[currentChatFriend]) {
                    delete users[currentUser].unreadMessages[currentChatFriend];
                    localStorage.setItem('users', JSON.stringify(users));
                    updateNotificationBadges();
                }
            } else {
                chatMessages.innerHTML = '';
                chatInput.disabled = true;
                sendMessageBtn.disabled = true;
                chatHeader.textContent = 'Select a friend to start chatting';
            }
        }

        function loadChat(friendUsername) {
            const users = JSON.parse(localStorage.getItem('users'));
            const chat = users[currentUser].chats[friendUsername] || [];
            
            chatMessages.innerHTML = '';
            
            if (chat.length === 0) {
                chatMessages.innerHTML = '<p>No messages yet. Start the conversation!</p>';
                return;
            }
            
            chat.forEach(message => {
                const isCurrentUser = message.sender === currentUser;
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
                
                messageElement.innerHTML = `
                    <div class="message-content">${message.text}</div>
                    <div class="message-info">
                        ${formatChatTime(message.timestamp)}
                        ${isCurrentUser ? '' : `• ${message.sender}`}
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const messageText = chatInput.value.trim();
            
            if (!messageText || !currentChatFriend) {
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            const timestamp = new Date().toISOString();
            
            // Add message to sender's chat
            users[currentUser].chats[currentChatFriend].push({
                sender: currentUser,
                text: messageText,
                timestamp: timestamp
            });
            
            // Add message to recipient's chat
            users[currentChatFriend].chats[currentUser].push({
                sender: currentUser,
                text: messageText,
                timestamp: timestamp
            });
            
            // Mark as unread if recipient isn't currently viewing the chat
            if (!users[currentChatFriend].unreadMessages) {
                users[currentChatFriend].unreadMessages = {};
            }
            
            if (localStorage.getItem('currentUser') !== currentChatFriend) {
                if (!users[currentChatFriend].unreadMessages[currentUser]) {
                    users[currentChatFriend].unreadMessages[currentUser] = 0;
                }
                users[currentChatFriend].unreadMessages[currentUser]++;
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            
            // Update UI
            chatInput.value = '';
            loadChat(currentChatFriend);
            
            // Update notification badges for recipient
            updateNotificationBadges();
        }

        function updateChat() {
            if (currentChatFriend) {
                loadChat(currentChatFriend);
            }
        }

        // Notification functions
        function updateNotificationBadges() {
            if (!currentUser) return;
            
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[currentUser];
            
            // Friend request notifications
            const friendRequestCount = user.friendRequests?.length || 0;
            if (friendRequestCount > 0) {
                friendNotificationBadge.textContent = friendRequestCount;
                friendNotificationBadge.classList.remove('hidden');
            } else {
                friendNotificationBadge.classList.add('hidden');
            }
            
            // Chat notifications
            const unreadMessages = user.unreadMessages || {};
            const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
            
            if (totalUnread > 0) {
                chatNotificationBadge.textContent = totalUnread;
                chatNotificationBadge.classList.remove('hidden');
            } else {
                chatNotificationBadge.classList.add('hidden');
            }
        }

        // Helper functions
        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="myscripts.js"></script>
</body>
</html>
